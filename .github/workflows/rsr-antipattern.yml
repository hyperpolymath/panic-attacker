# SPDX-License-Identifier: PMPL-1.0-or-later
name: RSR Antipattern Detection

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  check:
    name: Detect RSR Antipatterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Check for SCM files in root
        run: |
          if [ -f "STATE.scm" ] || [ -f "ECOSYSTEM.scm" ] || [ -f "META.scm" ]; then
            echo "❌ CRITICAL: SCM files found in repository root!"
            echo "SCM files MUST be in .machine_readable/ directory only"
            exit 1
          fi
          echo "✅ No SCM files in root (correct)"

      - name: Check for AI manifest
        run: |
          if [ ! -f "AI.a2ml" ]; then
            echo "❌ Missing AI.a2ml manifest"
            exit 1
          fi
          echo "✅ AI manifest present"

      - name: Check for proper author attribution
        run: |
          if grep -r "hyperpolymath" --include="*.toml" --include="*.rs" | grep -i "author"; then
            echo "❌ Found 'hyperpolymath' as author name"
            echo "Use 'Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>' instead"
            exit 1
          fi
          echo "✅ Author attribution correct"

      - name: Check license consistency
        run: |
          if grep -r "AGPL" --include="*.rs" --include="*.toml" --include="LICENSE*"; then
            echo "❌ Found AGPL license references"
            echo "Should be PMPL-1.0-or-later"
            exit 1
          fi
          echo "✅ License consistent (PMPL)"
